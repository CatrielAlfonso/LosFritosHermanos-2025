<ion-header class="header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="volverAHome()">
        <ion-icon name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title class="titulo-pedidos">Mis Pedidos</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="container-pedidos">
  <!-- Estado vac铆o -->
  <div *ngIf="misPedidos().length === 0" class="estado-vacio">
    <ion-icon name="receipt-outline" class="icono-vacio"></ion-icon>
    <h2>No ten茅s pedidos</h2>
    <p>Realiz谩 tu primer pedido desde el men煤</p>
    <ion-button (click)="irAlMenu()" fill="solid" color="primary">
      Ver Men煤
    </ion-button>
  </div>

  <!-- Lista de pedidos -->
  <div *ngIf="misPedidos().length > 0" class="lista-pedidos">
    <div *ngFor="let pedido of misPedidos()" class="pedido-item" 
         [class.pedido-cancelado]="pedido.estado === 'cancelado'">
      
      <!-- Header del pedido -->
      <div class="pedido-header">
        <div class="pedido-info">
          <h2 class="pedido-fecha">{{pedido.fecha_pedido | date:'dd/MM/yyyy HH:mm'}}</h2>
          <div class="estado-badge" [class]="'estado-' + pedido.estado" 
               [class.estado-derivado]="pedido.estado === 'en preparacion' && (pedido.estado_comida === 'derivado' || pedido.estado_bebida === 'derivado')">
            {{getEstadoDetallado(pedido)}}
          </div>
        </div>
        <div class="pedido-total">
          <span class="total-pedido">{{pedido.cuenta | currency}}</span>
        </div>
      </div>
      
      <!-- Estados por sector (solo si est谩 en preparaci贸n) -->
      <div *ngIf="pedido.estado === 'en preparacion'" class="estados-sectores">
        <div *ngIf="getEstadoSectores(pedido).cocina" class="sector-estado">
          <ion-icon name="restaurant-outline"></ion-icon>
          <span class="sector-nombre">Cocina:</span>
          <span class="sector-valor" [class.listo]="pedido.estado_comida === 'listo'">
            {{getEstadoSectores(pedido).cocina}}
          </span>
        </div>
        <div *ngIf="getEstadoSectores(pedido).bar" class="sector-estado">
          <ion-icon name="wine-outline"></ion-icon>
          <span class="sector-nombre">Bar:</span>
          <span class="sector-valor" [class.listo]="pedido.estado_bebida === 'listo'">
            {{getEstadoSectores(pedido).bar}}
          </span>
        </div>
      </div>

      <!-- Motivo de rechazo -->
      <div *ngIf="pedido.estado === 'cancelado' && pedido.motivo_rechazo" 
           class="motivo-rechazo">
        <ion-icon name="warning-outline"></ion-icon>
        <div class="motivo-content">
          <strong>Motivo del rechazo:</strong>
          <p>{{pedido.motivo_rechazo}}</p>
        </div>
      </div>

      <!-- Resumen de productos -->
      <div class="resumen-productos">
        <div class="producto-resumen" *ngFor="let comida of pedido.comidas">
          <span class="producto-cantidad">{{comida.cantidad}}x</span>
          <span class="producto-nombre">{{comida.nombre}}</span>
          <span class="producto-precio">{{comida.precioTotal | currency}}</span>
        </div>
        <div class="producto-resumen" *ngFor="let bebida of pedido.bebidas">
          <span class="producto-cantidad">{{bebida.cantidad}}x</span>
          <span class="producto-nombre">{{bebida.nombre}}</span>
          <span class="producto-precio">{{bebida.precioTotal | currency}}</span>
        </div>
        <div class="producto-resumen" *ngFor="let postre of pedido.postres">
          <span class="producto-cantidad">{{postre.cantidad}}x</span>
          <span class="producto-nombre">{{postre.nombre}}</span>
          <span class="producto-precio">{{postre.precioTotal | currency}}</span>
        </div>
      </div>

      <!-- Botones para pedidos cancelados -->
      <div *ngIf="pedido.estado === 'cancelado'" class="pedido-actions">
        <button class="btn-modificar" (click)="modificarPedido(pedido)">
          <ion-icon name="create-outline"></ion-icon>
          Modificar
        </button>
        <button class="btn-eliminar" (click)="eliminarPedido(pedido)">
          <ion-icon name="trash-outline"></ion-icon>
          Eliminar
        </button>
      </div>
      <!-- Bot贸n Confirmar Recepci贸n - cuando el mozo entreg贸 pero el cliente no confirm贸 -->
      @if(pedido.estado === 'entregado' && !pedido.recepcion){
        <div class="pedido-actions">
          <button class="btn-confirmar-recepcion" (click)="confirmarRecepcion(pedido)">
            <ion-icon name="checkmark-done-circle-outline"></ion-icon>
            Confirmar Recepci贸n del Pedido
          </button>
        </div>
      }

      <!-- Bot贸n Pedir Cuenta - solo despu茅s de confirmar recepci贸n -->
      @if(pedido.estado === 'entregado' && pedido.recepcion && !pedido.solicita_cuenta && !pedido.cuenta_habilitada){
        <div class="pedido-actions">
          <button class="btn-pedir-cuenta" (click)="pedirCuenta(pedido)">
            <ion-icon name="receipt-outline"></ion-icon>
            Pedir Cuenta
          </button>
        </div>
      }
      <!-- Cuenta solicitada - Escanear QR Propina (si no carg贸 propina a煤n) -->
      @if(pedido.solicita_cuenta && pedido.propina === null){
        <div class="pedido-actions">
          <button class="btn-escanear-propina" (click)="escanearQRPropina(pedido)">
            <ion-icon name="qr-code-outline"></ion-icon>
            Escanear QR Propina
          </button>
        </div>
      }

      <!-- Propina cargada - Esperando que el mozo habilite la cuenta -->
      @if(pedido.solicita_cuenta && pedido.propina !== null && !pedido.cuenta_habilitada){
        <div class="propina-cargada">
          <ion-icon name="checkmark-circle"></ion-icon>
          <span>Propina: {{pedido.propina}}%</span>
          <span class="estado-espera">Esperando habilitaci贸n del mozo...</span>
        </div>
      }

      <!-- Cuenta habilitada - Mostrar detalle completo y bot贸n pagar -->
      @if(pedido.cuenta_habilitada && pedido.estado !== 'pagado_pendiente' && pedido.estado !== 'finalizado'){
        <div class="detalle-cuenta">
          <h4 class="detalle-titulo">
            <ion-icon name="receipt-outline"></ion-icon>
            Detalle de la Cuenta
          </h4>
          
          <!-- Productos pedidos con precios unitarios -->
          <div class="seccion-productos">
            @if(pedido.comidas && pedido.comidas.length > 0){
              <div class="categoria-productos">
                <span class="categoria-titulo"> Comidas</span>
                @for(item of pedido.comidas; track item.nombre){
                  <div class="producto-linea">
                    <div class="producto-info">
                      <span class="producto-cantidad">{{item.cantidad}}x</span>
                      <span class="producto-nombre">{{item.nombre}}</span>
                      <span class="producto-precio-unit">({{item.precio | currency}} c/u)</span>
                    </div>
                    <span class="producto-importe">{{item.precio * item.cantidad | currency}}</span>
                  </div>
                }
              </div>
            }
            
            @if(pedido.bebidas && pedido.bebidas.length > 0){
              <div class="categoria-productos">
                <span class="categoria-titulo">イ Bebidas</span>
                @for(item of pedido.bebidas; track item.nombre){
                  <div class="producto-linea">
                    <div class="producto-info">
                      <span class="producto-cantidad">{{item.cantidad}}x</span>
                      <span class="producto-nombre">{{item.nombre}}</span>
                      <span class="producto-precio-unit">({{item.precio | currency}} c/u)</span>
                    </div>
                    <span class="producto-importe">{{item.precio * item.cantidad | currency}}</span>
                  </div>
                }
              </div>
            }
            
            @if(pedido.postres && pedido.postres.length > 0){
              <div class="categoria-productos">
                <span class="categoria-titulo"> Postres</span>
                @for(item of pedido.postres; track item.nombre){
                  <div class="producto-linea">
                    <div class="producto-info">
                      <span class="producto-cantidad">{{item.cantidad}}x</span>
                      <span class="producto-nombre">{{item.nombre}}</span>
                      <span class="producto-precio-unit">({{item.precio | currency}} c/u)</span>
                    </div>
                    <span class="producto-importe">{{item.precio * item.cantidad | currency}}</span>
                  </div>
                }
              </div>
            }
          </div>
          
          <!-- Separador -->
          <div class="separador-cuenta"></div>
          
          <!-- Subtotal -->
          <div class="linea-detalle subtotal">
            <span>Subtotal</span>
            <span>{{calcularSubtotal(pedido) | currency}}</span>
          </div>
          
          <!-- Descuento por juegos -->
          @if(pedido.descuento > 0){
            <div class="linea-detalle descuento">
              <div class="descuento-info">
                <ion-icon name="game-controller-outline"></ion-icon>
                <span>Descuento por Juegos ({{pedido.descuento}}%)</span>
              </div>
              <span class="descuento-monto">-{{calcularDescuento(pedido) | currency}}</span>
            </div>
          }
          
          <!-- Propina (grado de satisfacci贸n) -->
          @if(pedido.propina !== null && pedido.propina !== undefined){
            <div class="linea-detalle propina">
              <div class="propina-info">
                <ion-icon name="heart-outline"></ion-icon>
                <span>Propina - Satisfacci贸n ({{pedido.propina}}%)</span>
              </div>
              <span class="propina-monto">{{calcularPropina(pedido) | currency}}</span>
            </div>
          }
          
          <!-- Separador grueso -->
          <div class="separador-total"></div>
          
          <!-- TOTAL grande y claro -->
          <div class="linea-total-final">
            <span class="total-label">TOTAL A PAGAR</span>
            <span class="total-monto">{{calcularTotal(pedido) | currency}}</span>
          </div>
        </div>
        
        <div class="pedido-actions">
          <button class="btn-pagar" (click)="procesarPago(pedido)">
            <ion-icon name="card-outline"></ion-icon>
            Pagar {{calcularTotal(pedido) | currency}}
          </button>
        </div>
      }

      <!-- Pago realizado - Esperando confirmaci贸n del mozo -->
      @if(pedido.estado === 'pagado_pendiente'){
        <div class="pago-pendiente">
          <ion-icon name="hourglass-outline"></ion-icon>
          <div class="pago-pendiente-info">
            <span class="pago-titulo">Pago registrado: {{pedido.pagado | currency}}</span>
            <span class="pago-estado">Esperando confirmaci贸n del mozo...</span>
          </div>
        </div>
      }

      <!-- Pedido finalizado -->
      @if(pedido.estado === 'finalizado'){
        <div class="pedido-finalizado">
          <ion-icon name="checkmark-circle"></ion-icon>
          <span>隆Gracias por tu visita! Pedido finalizado.</span>
        </div>
      } 
      
      <!-- Info adicional para otros estados -->
       @if(pedido.estado !== 'cancelado' && pedido.estado !== 'entregado'){
         <div class="pedido-info-adicional">
           <div class="info-item">
             <ion-icon name="time-outline"></ion-icon>
             <span>Tiempo estimado: {{pedido.tiempo_estimado}} min</span>
           </div>
           <div class="info-item">
             <ion-icon name="location-outline"></ion-icon>
             <span>Mesa: {{pedido.mesa}}</span>
           </div>
         </div>
       }
    </div>
  </div>
</ion-content>