<ion-header>
  <ion-toolbar color="fritos-blue">
    <ion-buttons slot="start">
      <ion-button (click)="volver()">
        <ion-icon name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Mis Pedidos a Domicilio</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="cargarPedidos()">
        <ion-icon name="refresh-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="content-pedidos">
  <!-- Refresher -->
  <ion-refresher slot="fixed" (ionRefresh)="refrescar($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="pedidos-container">
    <!-- Loading -->
    <div *ngIf="cargando" class="loading-container">
      <app-fritos-spinner 
        size="large" 
        mensaje="Cargando tus pedidos...">
      </app-fritos-spinner>
    </div>

    <!-- Sin pedidos -->
    <div *ngIf="!cargando && pedidos.length === 0" class="empty-state">
      <ion-icon name="bicycle-outline"></ion-icon>
      <h2>No tienes pedidos a domicilio</h2>
      <p>Realiza tu primer pedido y lo ver√°s aqu√≠</p>
      <ion-button expand="block" routerLink="/delivery">
        Pedir a Domicilio
      </ion-button>
    </div>

    <!-- Lista de pedidos -->
    <div *ngIf="!cargando && pedidos.length > 0">
      <ion-card *ngFor="let pedido of pedidos" class="pedido-card">
        <ion-card-header [class.header-entregado]="pedido.estado === 'entregado'">
          <div class="header-content">
            <div class="pedido-numero">
              <ion-icon name="receipt-outline"></ion-icon>
              <span>Pedido #{{ pedido.id }}</span>
            </div>
            <ion-badge [color]="getColorEstado(pedido.estado)">
              {{ getTextoEstado(pedido.estado) }}
            </ion-badge>
          </div>
        </ion-card-header>

        <ion-card-content>
          <!-- Fecha -->
          <div class="info-row">
            <ion-icon name="calendar-outline"></ion-icon>
            <span>{{ formatearFecha(pedido.created_at!) }}</span>
          </div>

          <!-- Direcci√≥n -->
          <div class="info-row">
            <ion-icon name="location-outline"></ion-icon>
            <span>{{ pedido.direccion_completa }}</span>
          </div>

          <!-- Tiempo estimado de preparaci√≥n (solo cuando est√° confirmado o preparando) -->
          <div *ngIf="pedido.tiempo_estimado && (pedido.estado === 'confirmado' || pedido.estado === 'preparando')" class="info-row tiempo-estimado-row">
            <ion-icon name="time-outline"></ion-icon>
            <span class="tiempo-estimado">
              ‚è±Ô∏è Tiempo estimado: <strong>{{ pedido.tiempo_estimado }} minutos</strong>
            </span>
          </div>

          <!-- Estados de los sectores (solo cuando est√° confirmado o preparando) -->
          <div *ngIf="pedido.estado === 'confirmado' || pedido.estado === 'preparando'" class="estados-sectores">
            <div class="sectores-titulo">üìã Estado de preparaci√≥n:</div>
            
            <!-- Estado Cocina (si tiene comidas/postres) -->
            <div *ngIf="tieneComidas(pedido)" class="sector-estado">
              <span class="sector-nombre">üçΩÔ∏è Cocina:</span>
              <ion-badge [color]="getColorEstadoSector(pedido.estado_comida)">
                {{ getTextoEstadoSector(pedido.estado_comida) }}
              </ion-badge>
            </div>
            
            <!-- Estado Bar (si tiene bebidas) -->
            <div *ngIf="tieneBebidas(pedido)" class="sector-estado">
              <span class="sector-nombre">üçπ Bar:</span>
              <ion-badge [color]="getColorEstadoSector(pedido.estado_bebida)">
                {{ getTextoEstadoSector(pedido.estado_bebida) }}
              </ion-badge>
            </div>
          </div>

          <!-- Productos -->
          <div class="info-row">
            <ion-icon name="restaurant-outline"></ion-icon>
            @if(getTotalProductos(pedido) == 1){<span>{{ getTotalProductos(pedido) }} producto</span>}
            @else{<span>{{ getTotalProductos(pedido) }} productos</span>}
            
          </div>

          <!-- Total -->
          <div class="info-row total-row">
            <span class="label">Total:</span>
            <span class="precio">{{ formatearPrecio(pedido.precio_total || 0) }}</span>
          </div>

          <!-- Propina (si existe) -->
          <div *ngIf="pedido.propina && pedido.propina > 0" class="info-row propina-row">
            <span class="label">Propina dejada:</span>
            <span class="propina">{{ formatearPrecio(pedido.propina || 0) }}</span>
          </div>

          <!-- Botones de acci√≥n -->
          <div class="actions">
            <!-- Chat (solo si est√° en camino o preparando) -->
            <ion-button 
              *ngIf="pedido.estado === 'en_camino' || pedido.estado === 'preparando'"
              expand="block"
              fill="outline"
              color="tertiary"
              (click)="abrirChat(pedido)">
              <ion-icon name="chatbubble-outline" slot="start"></ion-icon>
              Chat con Repartidor
            </ion-button>

            <!-- Acciones para pedidos CONFIRMADOS o PREPARANDO (derivados a cocina/bar) -->
            <!-- El QR DELIVERY ya se escanea desde el Home, aqu√≠ solo mostramos el bot√≥n de juegos si ya escane√≥ -->
            <ng-container *ngIf="(pedido.estado === 'confirmado' || pedido.estado === 'preparando') && qrEscaneado">
              <ion-button 
                expand="block"
                fill="outline"
                color="warning"
                (click)="irAJuegos(pedido)">
                <ion-icon name="game-controller-outline" slot="start"></ion-icon>
                üéÆ Jugar por Descuento
              </ion-button>
            </ng-container>

            <!-- Acciones para pedidos ENTREGADOS (no confirmados a√∫n) -->
            <ng-container *ngIf="pedido.estado === 'entregado' && !pedidoYaConfirmado(pedido)">
              <!-- Si NO se escane√≥ el QR, mostrar bot√≥n para escanear -->
              <ng-container *ngIf="!qrEscaneado">
                <ion-button 
                  expand="block"
                  color="primary"
                  (click)="escanearQRDelivery()">
                  <ion-icon name="qr-code-outline" slot="start"></ion-icon>
                  Escanear QR DELIVERY
                </ion-button>
                <ion-card color="light" class="info-qr-card">
                  <ion-card-content>
                    <p>Escane√° el c√≥digo <strong>QR DELIVERY</strong> para acceder a juegos, encuesta y pagar</p>
                  </ion-card-content>
                </ion-card>
              </ng-container>

              <!-- Si S√ç se escane√≥ el QR, mostrar botones de acciones -->
              <ng-container *ngIf="qrEscaneado">
                <!-- Juegos -->
                <ion-button 
                  expand="block"
                  fill="outline"
                  color="warning"
                  (click)="irAJuegos(pedido)">
                  <ion-icon name="game-controller-outline" slot="start"></ion-icon>
                  üéÆ Jugar por Descuento
                </ion-button>

                <!-- Confirmar Entrega / Encuesta / Pedir Cuenta (todo en uno) -->
                <ion-button 
                  expand="block"
                  color="success"
                  (click)="confirmarEntrega(pedido)">
                  <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
                  Confirmar, Encuesta y Pagar
                </ion-button>
              </ng-container>
            </ng-container>

            <!-- Mensaje de confirmado -->
            <div *ngIf="pedidoYaConfirmado(pedido)" class="confirmado-msg">
              <ion-icon name="checkmark-circle-outline"></ion-icon>
              <span>Pedido confirmado y evaluado</span>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
    </div>
  </div>
</ion-content>

