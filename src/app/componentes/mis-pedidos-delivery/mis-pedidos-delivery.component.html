<ion-header>
  <ion-toolbar color="fritos-blue">
    <ion-buttons slot="start">
      <ion-button (click)="volver()">
        <ion-icon name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Mis Pedidos a Domicilio</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="cargarPedidos()">
        <ion-icon name="refresh-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="content-pedidos">
  <!-- Refresher -->
  <ion-refresher slot="fixed" (ionRefresh)="refrescar($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="pedidos-container">
    <!-- Loading -->
    <div *ngIf="cargando" class="loading-container">
      <app-fritos-spinner 
        size="large" 
        mensaje="Cargando tus pedidos...">
      </app-fritos-spinner>
    </div>

    <!-- Sin pedidos -->
    <div *ngIf="!cargando && pedidos.length === 0" class="empty-state">
      <ion-icon name="bicycle-outline"></ion-icon>
      <h2>No tienes pedidos a domicilio</h2>
      <p>Realiza tu primer pedido y lo ver√°s aqu√≠</p>
      <ion-button expand="block" routerLink="/delivery">
        Pedir a Domicilio
      </ion-button>
    </div>

    <!-- Lista de pedidos -->
    <div *ngIf="!cargando && pedidos.length > 0">
      <ion-card *ngFor="let pedido of pedidos" class="pedido-card">
        <ion-card-header [class.header-entregado]="pedido.estado === 'entregado'">
          <div class="header-content">
            <div class="pedido-numero">
              <ion-icon name="receipt-outline"></ion-icon>
              <span>Pedido #{{ pedido.id }}</span>
            </div>
            <ion-badge [color]="getColorEstado(pedido.estado)">
              {{ getTextoEstado(pedido.estado) }}
            </ion-badge>
          </div>
        </ion-card-header>

        <ion-card-content>
          <!-- Fecha -->
          <div class="info-row">
            <ion-icon name="calendar-outline"></ion-icon>
            <span>{{ formatearFecha(pedido.created_at!) }}</span>
          </div>

          <!-- Direcci√≥n -->
          <div class="info-row">
            <ion-icon name="location-outline"></ion-icon>
            <span>{{ pedido.direccion_completa }}</span>
          </div>

          <!-- Tiempo estimado de preparaci√≥n (solo cuando est√° confirmado o preparando) -->
          <div *ngIf="pedido.tiempo_estimado && (pedido.estado === 'confirmado' || pedido.estado === 'preparando')" class="info-row tiempo-estimado-row">
            <ion-icon name="time-outline"></ion-icon>
            <span class="tiempo-estimado">
              ‚è±Ô∏è Tiempo estimado: <strong>{{ pedido.tiempo_estimado }} minutos</strong>
            </span>
          </div>

          <!-- Estados de los sectores (solo cuando est√° confirmado o preparando) -->
          <div *ngIf="pedido.estado === 'confirmado' || pedido.estado === 'preparando'" class="estados-sectores">
            <div class="sectores-titulo">üìã Estado de preparaci√≥n:</div>
            
            <!-- Estado Cocina (si tiene comidas/postres) -->
            <div *ngIf="tieneComidas(pedido)" class="sector-estado">
              <span class="sector-nombre">üçΩÔ∏è Cocina:</span>
              <ion-badge [color]="getColorEstadoSector(pedido.estado_comida)">
                {{ getTextoEstadoSector(pedido.estado_comida) }}
              </ion-badge>
            </div>
            
            <!-- Estado Bar (si tiene bebidas) -->
            <div *ngIf="tieneBebidas(pedido)" class="sector-estado">
              <span class="sector-nombre">üçπ Bar:</span>
              <ion-badge [color]="getColorEstadoSector(pedido.estado_bebida)">
                {{ getTextoEstadoSector(pedido.estado_bebida) }}
              </ion-badge>
            </div>
          </div>

          <!-- Productos -->
          <div class="info-row">
            <ion-icon name="restaurant-outline"></ion-icon>
            @if(getTotalProductos(pedido) == 1){<span>{{ getTotalProductos(pedido) }} producto</span>}
            @else{<span>{{ getTotalProductos(pedido) }} productos</span>}
            
          </div>

          <!-- Total -->
          <div class="info-row total-row">
            <span class="label">Total:</span>
            <span class="precio">{{ formatearPrecio(pedido.precio_total || 0) }}</span>
          </div>

          <!-- Propina (si existe) -->
          <div *ngIf="pedido.propina !== undefined && pedido.propina !== null" class="info-row propina-row">
            <span class="label">Propina:</span>
            <span class="propina">{{ pedido.propina }}% ({{ formatearPrecio(calcularMontoPropina(pedido)) }})</span>
          </div>

          <!-- Descuento de juego (si existe) -->
          <div *ngIf="pedido.descuento_juego && pedido.descuento_juego > 0" class="info-row descuento-row">
            <span class="label">üéÆ Descuento juego:</span>
            <span class="descuento">-{{ pedido.descuento_juego }}%</span>
          </div>

          <!-- Botones de acci√≥n -->
          <div class="actions">
            <!-- Chat (solo si est√° en camino o preparando) -->
            <ion-button 
              *ngIf="pedido.estado === 'en_camino' || pedido.estado === 'preparando'"
              expand="block"
              fill="outline"
              color="tertiary"
              (click)="abrirChat(pedido)">
              <ion-icon name="chatbubble-outline" slot="start"></ion-icon>
              Chat con Repartidor
            </ion-button>

            <!-- ========== PEDIDOS CONFIRMADOS O PREPARANDO ========== -->
            <!-- El QR DELIVERY ya se escanea desde el Home, aqu√≠ solo mostramos el bot√≥n de juegos si ya escane√≥ -->
            <ng-container *ngIf="(pedido.estado === 'confirmado' || pedido.estado === 'preparando') && qrEscaneado">
              <ion-button 
                expand="block"
                fill="outline"
                color="warning"
                (click)="irAJuegos(pedido)">
                <ion-icon name="game-controller-outline" slot="start"></ion-icon>
                üéÆ Jugar por Descuento
              </ion-button>
            </ng-container>

            <!-- ========== PEDIDOS ENTREGADOS - FLUJO COMPLETO ========== -->
            <ng-container *ngIf="pedido.estado === 'entregado'">
              
              <!-- PASO 1: Si NO se escane√≥ el QR, mostrar bot√≥n para escanear -->
              <ng-container *ngIf="!qrEscaneado">
                <ion-button 
                  expand="block"
                  color="primary"
                  (click)="escanearQRDelivery()">
                  <ion-icon name="qr-code-outline" slot="start"></ion-icon>
                  Escanear QR DELIVERY
                </ion-button>
                <ion-card color="light" class="info-qr-card">
                  <ion-card-content>
                    <p>Escane√° el c√≥digo <strong>QR DELIVERY</strong> para confirmar recepci√≥n y acceder a juegos, encuesta y cuenta</p>
                  </ion-card-content>
                </ion-card>
              </ng-container>

              <!-- Si S√ç se escane√≥ el QR -->
              <ng-container *ngIf="qrEscaneado">
                
                <!-- PASO 2: Confirmar recepci√≥n del pedido (si no confirm√≥ a√∫n) -->
                <ng-container *ngIf="!recepcionConfirmada(pedido)">
                  <ion-button 
                    expand="block"
                    color="success"
                    (click)="confirmarRecepcionPedido(pedido)">
                    <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
                    ‚úÖ Confirmar Recepci√≥n del Pedido
                  </ion-button>
                  <ion-card color="light" class="info-qr-card">
                    <ion-card-content>
                      <p>Confirm√° que recibiste tu pedido completo (comidas, bebidas y postres) para acceder a juegos, encuesta y cuenta</p>
                    </ion-card-content>
                  </ion-card>
                </ng-container>

                <!-- PASO 3: Despu√©s de confirmar recepci√≥n, mostrar opciones -->
                <ng-container *ngIf="recepcionConfirmada(pedido)">
                  
                  <!-- Juegos - siempre disponible despu√©s de confirmar recepci√≥n -->
                  <ion-button 
                    expand="block"
                    fill="outline"
                    color="warning"
                    (click)="irAJuegos(pedido)">
                    <ion-icon name="game-controller-outline" slot="start"></ion-icon>
                    üéÆ Jugar por Descuento
                  </ion-button>

                  <!-- Encuesta - solo si no la complet√≥ a√∫n -->
                  <ion-button 
                    *ngIf="!encuestaRespondida(pedido)"
                    expand="block"
                    fill="outline"
                    color="primary"
                    (click)="irAEncuesta(pedido)">
                    <ion-icon name="clipboard-outline" slot="start"></ion-icon>
                    üìù Completar Encuesta
                  </ion-button>

                  <!-- Ver Resultados de Encuestas - siempre disponible -->
                  <ion-button 
                    expand="block"
                    fill="outline"
                    color="secondary"
                    (click)="verResultadosEncuestas(pedido)">
                    <ion-icon name="stats-chart-outline" slot="start"></ion-icon>
                    üìä Ver Resultados de Encuestas
                  </ion-button>

                  <!-- Pedir Cuenta - solo si no la solicit√≥ a√∫n -->
                  <ion-button 
                    *ngIf="!cuentaSolicitada(pedido)"
                    expand="block"
                    color="tertiary"
                    (click)="pedirCuenta(pedido)">
                    <ion-icon name="receipt-outline" slot="start"></ion-icon>
                    üìã Pedir Cuenta
                  </ion-button>

                  <!-- Escanear QR Propina - despu√©s de pedir cuenta y antes de tener propina -->
                  <ion-button 
                    *ngIf="cuentaSolicitada(pedido) && !tienePropina(pedido)"
                    expand="block"
                    color="warning"
                    (click)="escanearQRPropina(pedido)">
                    <ion-icon name="qr-code-outline" slot="start"></ion-icon>
                    üí∞ Escanear QR Propina
                  </ion-button>

                  <!-- Ver Detalle de Cuenta - despu√©s de tener propina -->
                  <ion-button 
                    *ngIf="tienePropina(pedido)"
                    expand="block"
                    color="success"
                    (click)="verDetalleCuenta(pedido)">
                    <ion-icon name="card-outline" slot="start"></ion-icon>
                    üí≥ Ver Detalle de Cuenta
                  </ion-button>

                </ng-container>
              </ng-container>
            </ng-container>

            <!-- Mensaje de confirmado (propina cargada) -->
            <div *ngIf="pedido.estado === 'entregado' && tienePropina(pedido)" class="confirmado-msg">
              <ion-icon name="checkmark-circle-outline"></ion-icon>
              <span>‚úÖ Propina: {{ pedido.propina }}% - Pedido completado</span>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
    </div>
  </div>
</ion-content>

