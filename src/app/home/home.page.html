<ion-header [translucent]="true" class="fritos-header">
  <ion-toolbar color="fritos-red">
    <ion-title class="fritos-logo titulo">
      LOS FRITOS HERMANOS
    </ion-title>
    <ion-buttons slot="end" *ngIf="nombreUsuario">
      <ion-button (click)="cerrarSesion()" color="light" class="logout-button">
        <ion-icon name="log-out-outline" slot="start" class="icono-cerrar"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="fritos-theme">
  <ion-header collapse="condense">
    <ion-toolbar color="fritos-red">
      <ion-title size="large" class="fritos-logo">LOS FRITOS HERMANOS</ion-title>
    </ion-toolbar>
  </ion-header>


  <div id="container" class="fritos-card" *ngIf="!nombreUsuario">
    <img src="https://jpwlvaprtxszeimmimlq.supabase.co/storage/v1/object/public/FritosHermanos/crispy2.png" alt="Logo" class="login-logo fritos-bounce" />
    <strong class="fritos-logo">Â¡Bienvenido a Los Fritos Hermanos!</strong>
    <p class="fritos-subtitle">Tu aplicaciÃ³n de comida rÃ¡pida favorita</p>
    <ion-button color="fritos-red" class="fritos-button" routerLink="/login">
      Iniciar SesiÃ³n
    </ion-button>
  </div>

 
  <div id="container" class="fritos-card" *ngIf="nombreUsuario">
    <img src="https://jpwlvaprtxszeimmimlq.supabase.co/storage/v1/object/public/FritosHermanos/crispy2.png" alt="Logo" class="login-logo fritos-bounce" />
    <strong class="fritos-logo">Â¡Bienvenido, {{ nombreUsuario }}!</strong>

  
    <div *ngIf="(tipoUsuario === 'dueÃ±o' || tipoUsuario === 'supervisor') && !esClienteAnonimo" class="admin-options">
      
      <ion-button expand="block" color="fritos-blue" class="fritos-button" (click)="irARegistro('/registro-empleados')">
        <ion-icon name="person-add-outline" slot="start"></ion-icon>
        Registrar Empleado
      </ion-button>

      <ion-button expand="block" color="fritos-orange" class="fritos-button" (click)="irARegistro('/registro-mesa')">
        <ion-icon name="restaurant-outline" slot="start"></ion-icon>
        Registrar Mesa
      </ion-button>

      <ion-button expand="block" color="fritos-orange" class="fritos-button" (click)="irAAprobacionClientes()">
        <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
        Aprobar Clientes
      </ion-button>

      <ion-button expand="block" color="fritos-green" class="fritos-button" routerLink="/gestionar-reservas">
        <ion-icon name="calendar-outline" slot="start"></ion-icon>
        Gestionar Reservas
      </ion-button>

      <ion-button expand="block" color="fritos-blue" class="fritos-button" routerLink="/gestionar-delivery">
        <ion-icon name="bicycle-outline" slot="start"></ion-icon>
        Gestionar Pedidos a Domicilio
      </ion-button>

    </div>

    <div *ngIf="esMaitre && !esAdmin && !esClienteAnonimo" class="maitre-options">
      
      <ion-button expand="block" color="fritos-blue" class="fritos-button" (click)="irARegistro('/registro')">
        <ion-icon name="person-add-outline" slot="start"></ion-icon>
        Registrar Cliente
      </ion-button>

      <ion-button expand="block" color="fritos-orange" class="fritos-button" (click)="irAMaitreMesas()">
        <ion-icon name="restaurant-outline" slot="start"></ion-icon>
        Gestionar Mesas
      </ion-button>

      <ion-button 
        *ngIf="perfilUsuario === 'maitre'" 
        expand="block" 
        class="btn-pedidos"
        (click)="irAListaEspera()">
        <div class="boton-contenido-columna">
          <ion-icon name="list-outline"></ion-icon>
          <span class="boton-texto">Lista de Espera</span>
        </div>
      </ion-button>
    </div>

 
    <div *ngIf="tipoUsuario === 'cocinero' && !esClienteAnonimo" class="cocinero-options">
      
      <ion-button expand="block" color="fritos-blue" class="fritos-button" (click)="irARegistro('/registro-plato')">
        <ion-icon name="restaurant-outline" slot="start"></ion-icon>
        Registrar Producto
      </ion-button>

      <ion-button expand="block" color="fritos-orange" class="fritos-button" (click)="irAVerPedidosCocina()">
        <ion-icon name="list-outline" slot="start" ></ion-icon>
        Ver Pedidos
      </ion-button>
    </div>

    <div *ngIf="tipoUsuario === 'bartender' && !esClienteAnonimo" class="bartender-options">
      
      <ion-button expand="block" color="fritos-blue" class="fritos-button" [routerLink]="['/bebidas']" routerLinkActive="router-link-active" >
        <ion-icon name="wine-outline" slot="start"></ion-icon>
        Registrar Bebida
      </ion-button>

      <ion-button expand="block" color="fritos-orange" class="fritos-button" (click)="irAVerPedidosBar()">
        <ion-icon name="list-outline" slot="start"></ion-icon>
        Ver Pedidos
      </ion-button>
    </div>

    <div *ngIf="tipoUsuario === 'mozo' && !esClienteAnonimo" class="mozo-options">
      
      <ion-button expand="block" color="fritos-blue" class="fritos-button" (click)="irAPedidosMozo()">
        <ion-icon name="clipboard-outline" slot="start"></ion-icon>
        Ver Pedidos Pendientes
      </ion-button>

      <ion-button expand="block" color="fritos-green" class="fritos-button" (click)="irAConsultasMozo()">
        <ion-icon name="chatbubbles-outline" slot="start"></ion-icon>
        Ver Consultas de Clientes
      </ion-button>
    </div>

    <div *ngIf="tipoUsuario === 'repartidor' && !esClienteAnonimo" class="repartidor-options">
      
      <ion-button expand="block" color="fritos-blue" class="fritos-button" routerLink="/panel-repartidor">
        <ion-icon name="bicycle-outline" slot="start"></ion-icon>
        Mis Pedidos Asignados
      </ion-button>
    </div>

    <div *ngIf="tipoUsuario === 'cliente' || esClienteAnonimo" class="cliente-options">
      
      <!-- BotÃ³n para clientes anÃ³nimos: Escanear QR para Ver Encuestas -->
      @if (esClienteAnonimo)
      {
        <ion-button
          expand="block" 
          color="fritos-red" 
          class="fritos-button" 
          (click)="ocultarMensajeListaEspera(); escanearQRParaVerEncuestas()">
          <ion-icon name="qr-code-outline" slot="start"></ion-icon>
          Escanear QR para Ver Encuestas
        </ion-button>
      }
      
      @if (esClienteAnonimo && yaEnListaEspera && !mesaAsignada && mostrarMensajeListaEspera)
      {
        <ion-card color="warning">
          <ion-card-content>
            <p>âœ… Ya estÃ¡s en la lista de espera. El maÃ®tre te asignarÃ¡ una mesa pronto.</p>
            <ion-button fill="clear" size="small" (click)="ocultarMensajeListaEspera()">
              Cerrar
            </ion-button>
          </ion-card-content>
        </ion-card>
      }
      
      <ion-button expand="block" color="fritos-blue" class="fritos-button" [routerLink]="['/menu']" (click)="ocultarMensajeListaEspera()">
        <ion-icon name="restaurant-outline" slot="start"></ion-icon>
        Ver Carta
      </ion-button>

      <ion-button expand="block" color="fritos-orange" class="fritos-button" [routerLink]="['/reservas']" (click)="ocultarMensajeListaEspera()">
        <ion-icon name="calendar-outline" slot="start"></ion-icon>
        Mis Reservas
      </ion-button>

      <ion-button expand="block" color="fritos-green" class="fritos-button" [routerLink]="['/menu']" [queryParams]="{tipo: 'delivery'}" (click)="ocultarMensajeListaEspera()">
        <ion-icon name="bicycle-outline" slot="start"></ion-icon>
        Pedir a Domicilio
      </ion-button>

      <!-- Escanear QR DELIVERY - visible cuando tiene pedido confirmado y NO escaneÃ³ el QR -->
      @if (tienePedidoDeliveryConfirmado && !qrDeliveryEscaneado) {
        <ion-button expand="block" color="fritos-orange" class="fritos-button" (click)="escanearQRDelivery()">
          <ion-icon name="qr-code-outline" slot="start"></ion-icon>
          Escanear QR EnvÃ­os a Domicilio
        </ion-button>

      }

      <!-- Mis Pedidos a Domicilio - visible solo despuÃ©s de escanear QR DELIVERY (si tiene pedido confirmado) -->
      @if (!tienePedidoDeliveryConfirmado || qrDeliveryEscaneado) {
        <ion-button expand="block" color="fritos-blue" class="fritos-button" routerLink="/mis-pedidos-delivery" (click)="ocultarMensajeListaEspera()">
          <ion-icon name="receipt-outline" slot="start"></ion-icon>
          Mis Pedidos a Domicilio
        </ion-button>
      }

      <!-- Juegos para Delivery - visible despuÃ©s de escanear QR DELIVERY y tener pedido confirmado -->
      @if (tienePedidoDeliveryConfirmado && qrDeliveryEscaneado) {
        <ion-button expand="block" color="fritos-red" class="fritos-button" (click)="irAJuegos()">
          <ion-icon name="game-controller-outline" slot="start"></ion-icon>
          ðŸŽ® Jugar por Descuento
        </ion-button>
      }

      <!-- BotÃ³n Escanear QR Mesa - siempre visible mientras tenga mesa asignada -->
      @if ((tipoUsuario === 'cliente' || esClienteAnonimo) && mostrarBotonEscanearMesa)
      {
        <ion-button
        expand="block" color="fritos-orange" class="fritos-button" (click)="escanearMesaAsignada()">
          <ion-icon name="qr-code-outline" slot="start"></ion-icon>
          Escanear QR Mesa
        </ion-button>
      }
      
      <!-- BotÃ³n Ver Estado del Pedido - visible despuÃ©s de escanear QR y tener pedido -->
      @if ((perfilUsuario === 'cliente' || esClienteAnonimo) && mostrarBotonVerEstadoPedido && pedidoActualCliente && qrMesaEscaneado)
      {
        <ion-button expand="block" color="fritos-blue" class="fritos-button" (click)="irAVerEstadoPedido()">
          <ion-icon name="clipboard-outline" slot="start"></ion-icon>
          Ver Estado del Pedido
        </ion-button>
      }

      <!-- Juegos - visible despuÃ©s de escanear QR y cuando el pedido estÃ¡ confirmado O despuÃ©s de confirmar recepciÃ³n -->
      @if ((perfilUsuario === 'cliente' || esClienteAnonimo) && pedidoActualCliente && qrMesaEscaneado && (
        (pedidoActualCliente.confirmado && (pedidoActualCliente.estado === 'en preparacion' || pedidoActualCliente.estado === 'listo')) ||
        (pedidoActualCliente.estado === 'entregado' && pedidoActualCliente.recepcion)
      ))
      {
        <ion-button expand="block" color="fritos-green" class="fritos-button" (click)="irAJuegos()">
          <ion-icon name="game-controller-outline" slot="start"></ion-icon>
          Juegos
        </ion-button>
      }

      <!-- Encuestas - visible despuÃ©s de confirmar recepciÃ³n del pedido (si no completÃ³ encuesta) -->
      @if ((perfilUsuario === 'cliente' || esClienteAnonimo) && pedidoActualCliente?.recepcion && pedidoActualCliente?.estado === 'entregado' && !clienteInfo?.encuesta && qrMesaEscaneado)
      {
        <ion-button expand="block" color="fritos-red" class="fritos-button" (click)="irAEncuestas()">
          <ion-icon name="chatbubbles-outline" slot="start"></ion-icon>
          Encuestas
        </ion-button>
      }

      <!-- Ver Resultados de Encuestas - visible si ya completÃ³ la encuesta -->
      @if ((perfilUsuario === 'cliente' || esClienteAnonimo) && clienteInfo?.encuesta && qrMesaEscaneado)
      {
        <ion-button expand="block" color="fritos-orange" class="fritos-button" (click)="verResultadosEncuestas()">
          <ion-icon name="stats-chart-outline" slot="start"></ion-icon>
          Ver Resultados de Encuestas
        </ion-button>
      }

      @if((perfilUsuario === 'cliente' || esClienteAnonimo) && !yaEnListaEspera && !clienteSentado)
      {
        <ion-button 
          expand="block" 
          class="btn-pedidos btn-solicitar-mesa"
          (click)="ocultarMensajeListaEspera(); escanearQR()">
          <div class="boton-contenido-columna">
            <ion-icon name="qr-code-outline"></ion-icon>
            <span class="boton-texto">SOLICITAR MESA</span>
          </div>
        </ion-button>
      }




      <ion-modal [isOpen]="mostrarModalConsultasMozo" (didDismiss)="cerrarModalConsultasMozo()">
    <ng-template>
      <ion-content>
        <div class="modal-title-container">
          <ion-button fill="clear" class="close-button" (click)="cerrarModalConsultasMozo()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
          <h2 class="modal-title">Consultas de clientes</h2>
        </div>
        <div class="clientes-container">
          <div *ngIf="cargandoConsultasMozo" class="loading-container"><p>Cargando consultas...</p></div>
          <div *ngIf="!cargandoConsultasMozo && consultasMozo.length === 0" class="modal-empty">No hay consultas.</div>
          <div *ngFor="let consulta of consultasMozo" class="cliente-item">
            <div class="cliente-info">
              <div class="cliente-nombre" style="display: flex; justify-content: center; width: 100%;">Mesa NÂ° {{ consulta.mesa }}</div>
              <div class="cliente-meta">{{ formatearHoraConsulta(consulta.hora) }}</div>
              <div class="cliente-correo">{{ consulta.consulta }}</div>
            </div>
            <div class="mesa-actions">
              <ng-container *ngIf="!consulta.respuesta">
                <ion-button *ngIf="mostrarRespuestaId !== consulta.id" fill="outline" color="success" size="small" (click)="mostrarRespuestaId = consulta.id">
                  <ion-icon name="chatbox-ellipses" slot="start"></ion-icon>
                  Responder
                </ion-button>
                <div *ngIf="mostrarRespuestaId === consulta.id" class="respuesta-form">
                  <textarea [(ngModel)]="respuestaMozoPorId[consulta.id]" placeholder="Escribe tu respuesta..." rows="2"></textarea>
                  <div *ngIf="errorRespuestaMozoPorId[consulta.id]" class="error-consulta-mozo">{{ errorRespuestaMozoPorId[consulta.id] }}</div>
                  <ion-button class="btn-accion btn-confirmar" color="success" (click)="enviarRespuestaMozo(consulta)" [disabled]="!respuestaMozoPorId[consulta.id] || !respuestaMozoPorId[consulta.id].trim()">Enviar</ion-button>
                  <ion-button fill="clear" color="danger" size="small" (click)="mostrarRespuestaId = null">Cancelar</ion-button>
                </div>
              </ng-container>
              <div *ngIf="consulta.respuesta" class="respuesta-mozo">
                <div class="respuesta-label">Respuesta del mozo:</div>
                <div class="respuesta-texto">{{ consulta.respuesta }}</div>
                <div class="respuesta-meta">Por: {{ consulta.mozo }} | {{ formatearHoraConsulta(consulta.hora_respuesta) }}</div>
              </div>
            </div>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

    </div>
  </div>
</ion-content>